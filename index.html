<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BINGO PRO | Mapeo de Cartones por ID</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Habilitar logs de debug de Firestore (opcional, ayuda en la depuración)
        setLogLevel('Debug');

        // Variables Globales Inyectadas por el entorno (¡OBLIGATORIAS!)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Exponer las funciones y objetos de Firebase a la ventana global para usarlos en el script de React/Babel
        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.getAuth = getAuth;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.doc = doc;
        window.getDoc = getDoc;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.__app_id = appId; // Exportar appId
        // Asegurar polyfill para randomUUID si no existe
        window.crypto = window.crypto || window.msCrypto;
        window.randomUUID = window.crypto.randomUUID;

        // Función de autenticación inicial (Usando el token inyectado o anónimo)
        async function authenticate() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error durante la autenticación:", error);
            }
        }
        authenticate();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Estilos para el efecto de carga */
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ocultar elementos en la impresión */
        @media print {
            .no-print { display: none !important; }
            .card-container { margin: 0; padding: 0; border: none; box-shadow: none; }
            body { background-color: white !important; }
            /* Asegurar que la imagen del cartón ocupe todo el ancho sin márgenes */
            .printable-image-container img { width: 100%; height: auto; }
        }

        /* Estilo para el botón de eliminación */
        .delete-btn {
            background-color: #ef4444; /* Rojo 500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }

        .delete-btn:hover {
            background-color: #dc2626; /* Rojo 600 */
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- Contenedor para la aplicación React -->
        <div class="h-screen flex items-center justify-center bg-gray-100">
            <div class="loader"></div>
            <p class="ml-4 text-lg font-medium text-gray-600">Cargando Bingo App...</p>
        </div>
    </div>

    <script type="text/babel">
        // ==========================================
        // CONFIGURACIÓN E INICIALIZACIÓN (React Hooks)
        // ==========================================
        const { useState, useEffect, useCallback } = React;
        const { db, auth, onAuthStateChanged, signOut, collection, query, where, getDocs, onSnapshot, addDoc, deleteDoc, doc, setDoc, randomUUID, __app_id, signInWithEmailAndPassword } = window;

        // ID fijo del administrador donde se guardan los cartones y la configuración
        // Si el admin inicia sesión con 'admin@bingo.com' por primera vez, este UID será su ID.
        const FIXED_ADMIN_ID = 'FeFgVxeONgcYMNLNRb3rrhhI6Eym'; 
        const PLAYERS_COLLECTION_PATH = `artifacts/${__app_id}/users/${FIXED_ADMIN_ID}/jugadores`;
        const CONFIG_DOC_PATH = `artifacts/${__app_id}/users/${FIXED_ADMIN_ID}/config/url_settings`;

        // Configuración por defecto (ajustada a la nomenclatura del usuario: 'carta' y '.jpeg')
        const DEFAULT_URL_CONFIG = {
            baseUrl: 'https://raw.githubusercontent.com/TuUsuario/TuRepo/main/cartones/',
            filePrefix: 'carta',
            fileExt: '.jpeg'
        };


        // ------------------------------------------
        // LÓGICA DE NEGOCIO Y FIREBASE
        // ------------------------------------------
        
        /**
         * Maneja el cierre de sesión del administrador.
         * @param {function} setView - Función para cambiar la vista.
         * @param {function} showMessage - Función para mostrar mensajes.
         */
        const manejarCerrarSesion = async (setView, showMessage) => {
            try {
                await signOut(auth);
                setView('finder');
                showMessage('Sesión cerrada correctamente.', 'success');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showMessage('Error al cerrar sesión. Inténtalo de nuevo.', 'error');
            }
        };

        /**
         * Maneja la eliminación de un documento de jugador.
         * @param {string} playerId - ID del documento a eliminar.
         * @param {function} showMessage - Función para mostrar mensajes.
         */
        const handleDelete = async (playerId, showMessage) => {
            const confirmed = window.confirm("¿Estás seguro de que quieres eliminar este cartón? Esta acción es irreversible.");
            
            if (confirmed) {
                try {
                    const docRef = doc(db, PLAYERS_COLLECTION_PATH, playerId);
                    await deleteDoc(docRef);
                    showMessage(`Cartón ID ${playerId.substring(0, 5)}... eliminado.`, 'success');
                } catch (error) {
                    console.error("Error al eliminar documento:", error);
                    showMessage('Error de eliminación. Revise la consola.', 'error');
                }
            }
        };
        
        /**
         * Guarda la configuración de la URL base en Firestore.
         * @param {object} config - Objeto con baseUrl, filePrefix, y fileExt.
         * @param {function} showMessage - Función para mostrar mensajes.
         */
        const saveUrlConfig = async (config, showMessage) => {
            try {
                // Guarda la configuración en el documento fijo del administrador
                await setDoc(doc(db, CONFIG_DOC_PATH), config);
                showMessage('Configuración de URL guardada en Firestore.', 'success');
            } catch (error) {
                console.error("Error al guardar la configuración:", error);
                showMessage('Error al guardar la configuración en Firestore.', 'error');
            }
        };

        /**
         * Guarda un nuevo jugador/cartón en Firestore solo con el nombre y el ID del ticket.
         * La URL se construye dinámicamente al mostrarse.
         * @param {string} clientName - Nombre del cliente/jugador.
         * @param {string} ticketId - Número de ticket (ej: "001").
         * @param {function} showMessage - Función para mostrar mensajes.
         * @param {function} resetForm - Función para limpiar el formulario.
         */
        const manejarGuardar = async (clientName, ticketId, showMessage, resetForm) => {
            try {
                // 1. Verificar si el ticketId ya existe
                const q = query(collection(db, PLAYERS_COLLECTION_PATH), where("ticketId", "==", ticketId));
                const existingDocs = await getDocs(q);

                if (!existingDocs.empty) {
                    showMessage(`El número de ticket ${ticketId} ya está registrado a nombre de ${existingDocs.docs[0].data().clientName}.`, 'warning');
                    return;
                }

                // 2. Crear el objeto de datos
                const playerData = {
                    clientName: clientName.trim(),
                    ticketId: ticketId.trim(),
                    title: "GRAN BINGO MASTER", // Título por defecto
                    timestamp: new Date().toISOString()
                };

                // 3. Guardar en Firestore
                await addDoc(collection(db, PLAYERS_COLLECTION_PATH), playerData);
                
                showMessage(`Cartón #${ticketId} registrado con éxito.`, 'success');
                resetForm();

            } catch (error) {
                console.error("Error al guardar documento:", error);
                showMessage('Error al guardar. Revise la consola.', 'error');
            }
        };

        /**
         * Busca un cartón de bingo por número de ticket.
         * @param {string} ticketId - El número de ticket a buscar (ej: "001").
         * @param {function} setFoundPlayer - Función para actualizar el jugador encontrado.
         * @param {function} showMessage - Función para mostrar mensajes.
         */
        const manejarBusqueda = async (ticketId, setFoundPlayer, showMessage) => {
            setFoundPlayer(null); // Limpiar resultado anterior

            if (ticketId.length !== 3) {
                showMessage('El número de ticket debe ser de 3 dígitos (ej: "001").', 'warning');
                return;
            }

            try {
                // Usamos la ruta de colección fija del administrador para buscar
                const q = query(collection(db, PLAYERS_COLLECTION_PATH), where("ticketId", "==", ticketId));
                
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    // Asumiendo que ticketId es único, tomamos el primer resultado
                    const doc = querySnapshot.docs[0];
                    setFoundPlayer({ id: doc.id, ...doc.data() });
                } else {
                    showMessage(`No se encontró ningún cartón con el número ${ticketId}.`, 'error');
                }
            } catch (error) {
                console.error("Error en la búsqueda:", error);
                showMessage('Error de búsqueda. Inténtalo más tarde.', 'error');
            }
        };

        /**
         * Función que construye la URL de la imagen del cartón.
         */
        const buildImageUrl = (ticketId, urlConfig) => {
            const { baseUrl, filePrefix, fileExt } = urlConfig;
            const paddedTicket = ticketId.padStart(3, '0');
            const fileName = `${filePrefix}${paddedTicket}${fileExt}`;
            // Asegura que solo haya un separador / entre la base y el archivo
            return `${baseUrl.endsWith('/') ? baseUrl : baseUrl + '/'}${fileName}`; 
        }

        // ------------------------------------------
        // COMPONENTES DE VISTA
        // ------------------------------------------

        /**
         * Componente para mostrar el modal de mensajes.
         */
        const MessageModal = ({ message, type, isVisible, onClose }) => {
            const baseClasses = "fixed bottom-5 right-5 p-4 rounded-lg shadow-xl z-50 transform transition-transform duration-500";
            let colorClasses = "";

            switch (type) {
                case 'success':
                    colorClasses = "bg-green-500 text-white";
                    break;
                case 'error':
                    colorClasses = "bg-red-500 text-white";
                    break;
                case 'warning':
                    colorClasses = "bg-yellow-500 text-black";
                    break;
                default:
                    colorClasses = "bg-gray-700 text-white";
            }

            const visibilityClass = isVisible ? "translate-y-0 opacity-100" : "translate-y-20 opacity-0";

            if (!isVisible) return null;

            return (
                <div className={`${baseClasses} ${colorClasses} ${visibilityClass} no-print`}>
                    <p className="font-semibold">{message}</p>
                    <button onClick={onClose} className="ml-4 font-bold text-lg leading-none">&times;</button>
                </div>
            );
        };
        
        /**
         * Componente que renderiza el cartón de Bingo como una imagen (JPEG subido)
         * @param {object} player - Objeto del jugador con los datos del cartón.
         * @param {object} urlConfig - Objeto con la configuración de la URL para construir el path.
         */
        const BingoCard = ({ player, urlConfig }) => {
            if (!urlConfig || !player || !player.ticketId) {
                return (
                    <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mx-auto my-8 text-center">
                        <p className="text-red-500 font-bold">Error: Datos incompletos para mostrar el cartón.</p>
                    </div>
                );
            }

            // CONSTRUIR LA URL DINÁMICAMENTE
            const imageUrl = buildImageUrl(player.ticketId, urlConfig);

            // Usamos un placeholder genérico en caso de que la URL pública falle
            const placeholderUrl = "https://placehold.co/800x600/ef4444/ffffff?text=IMAGEN+NO+DISPONIBLE";

            return (
                <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mx-auto my-8 printable-image-container card-container">
                    <div className="text-center mb-4 no-print">
                        <span className="text-xs font-bold bg-indigo-100 text-indigo-600 rounded-full px-3 py-1 mb-2 inline-block">
                            # TICKET #{player.ticketId}
                        </span>
                        <h3 className="text-3xl font-extrabold text-indigo-600 tracking-tight">
                            {player.title || "CARTÓN BINGO"}
                        </h3>
                        <p className="text-lg font-semibold text-gray-700 mt-1">{player.clientName.toUpperCase()}</p>
                        <p className="text-xs text-gray-400 break-words mt-1">
                            URL Construida: {imageUrl}
                        </p>
                    </div>

                    <div className="w-full h-auto overflow-hidden rounded-lg shadow-lg border-4 border-indigo-200">
                        {/* Muestra la imagen. Si falla al cargar (ej: URL incorrecta), muestra el placeholder. */}
                        <img 
                            src={imageUrl} 
                            alt={`Cartón Bingo para ${player.clientName} - Ticket ${player.ticketId}`} 
                            className="w-full h-auto object-cover"
                            onError={(e) => {
                                e.target.onerror = null; 
                                e.target.src = placeholderUrl;
                            }}
                        />
                    </div>
                    
                    <div className="text-xs text-gray-400 mt-4 flex justify-between no-print">
                        <span>Cartón Dinámico (Construido con URL Base)</span>
                        <span className="text-green-500 font-semibold">✓ Encontrado</span>
                    </div>
                </div>
            );
        };

        /**
         * Componente de búsqueda para el público/administrador
         */
        const FinderApp = ({ setView, showMessage, urlConfig }) => {
            const [ticket, setTicket] = useState('');
            const [foundPlayer, setFoundPlayer] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const isAdmin = auth.currentUser && auth.currentUser.email === 'admin@bingo.com';

            const handleSearch = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                // Aseguramos que el ticket sea exactamente 3 dígitos
                const paddedTicket = ticket.trim().padStart(3, '0'); 
                await manejarBusqueda(paddedTicket, setFoundPlayer, showMessage);
                setIsLoading(false);
            };

            return (
                <div className="min-h-screen flex flex-col items-center pt-10 px-4 bg-gray-100">
                    <nav className="fixed top-0 left-0 right-0 p-4 bg-white shadow-md z-10 no-print">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <h1 className="text-2xl font-black text-gray-800">
                                BINGO<span className="text-indigo-600">PRO</span>
                            </h1>
                            {isAdmin ? (
                                <button
                                    onClick={() => setView('admin')}
                                    className="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-full shadow-md hover:bg-indigo-700 transition duration-300"
                                >
                                    Panel Admin
                                </button>
                            ) : (
                                <button
                                    onClick={() => setView('login')}
                                    className="text-indigo-600 font-semibold hover:text-indigo-800 transition duration-300"
                                >
                                    Admin
                                </button>
                            )}
                        </div>
                    </nav>

                    <div className="w-full max-w-md mt-24">
                        {!foundPlayer ? (
                            <div className="text-center mb-8">
                                <h2 className="text-3xl font-bold text-gray-900 mb-2">
                                    Busca tu Cartón
                                </h2>
                                <p className="text-gray-500">
                                    Ingresa tu número de ticket (3 dígitos).
                                </p>
                            </div>
                        ) : (
                            <button
                                onClick={() => { setFoundPlayer(null); setTicket(''); }}
                                className="text-indigo-600 font-semibold mb-4 flex items-center hover:text-indigo-800 no-print"
                            >
                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                Cerrar Búsqueda
                            </button>
                        )}
                        
                        {/* Formulario de Búsqueda (Se oculta si ya hay un resultado) */}
                        {!foundPlayer && (
                            <form onSubmit={handleSearch} className="flex bg-white p-2 rounded-xl shadow-lg border border-gray-200">
                                <div className="flex items-center text-gray-500 p-2 font-mono text-lg">
                                    #
                                </div>
                                <input
                                    type="number"
                                    value={ticket}
                                    onChange={(e) => setTicket(e.target.value)}
                                    placeholder="001"
                                    maxLength="3"
                                    className="flex-grow p-2 text-xl focus:outline-none"
                                    required
                                />
                                <button
                                    type="submit"
                                    disabled={isLoading}
                                    className="w-16 h-12 bg-indigo-600 text-white rounded-lg flex items-center justify-center hover:bg-indigo-700 transition duration-300 disabled:opacity-50"
                                >
                                    {isLoading ? (
                                        <div className="loader w-6 h-6 border-white border-t-2"></div>
                                    ) : (
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    )}
                                </button>
                            </form>
                        )}
                    </div>

                    {/* Resultado de la Búsqueda */}
                    {foundPlayer && (
                        <>
                            <div className="w-full max-w-xl flex justify-end mt-4 no-print">
                                <button
                                    onClick={() => window.print()}
                                    className="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center"
                                >
                                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0v2a2 2 0 002 2h2a2 2 0 002-2v-2m0 0h-4"></path></svg>
                                    Imprimir Cartón
                                </button>
                            </div>
                            {/* Pasamos la configuración de URL para que el componente BingoCard construya el path */}
                            <BingoCard player={foundPlayer} urlConfig={urlConfig} />
                        </>
                    )}
                </div>
            );
        };

        /**
         * Componente de Login para el administrador
         */
        const AdminLogin = ({ setView, showMessage }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage('¡Bienvenido, Administrador!', 'success');
                    setView('admin');
                } catch (error) {
                    console.error("Error de inicio de sesión:", error);
                    showMessage('Credenciales incorrectas o usuario no registrado.', 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 px-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
                        <h1 className="text-2xl font-bold text-gray-800 text-center mb-6">
                            Acceso Administrativo
                        </h1>
                        <p className="text-sm text-center text-red-500 mb-4 font-semibold">
                            ⚠️ Use su cuenta de Firebase Auth.
                        </p>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">EMAIL</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder="admin@bingo.com" 
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">CONTRASEÑA</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="••••••••"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={isLoading}
                                className="w-full py-3 mt-4 bg-indigo-700 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-800 transition duration-300 flex items-center justify-center disabled:opacity-50"
                            >
                                {isLoading ? (
                                    <div className="loader w-5 h-5 border-white border-t-2"></div>
                                ) : (
                                    'Entrar'
                                )}
                            </button>
                        </form>
                        <div className="text-center mt-6">
                             <button
                                onClick={() => setView('finder')}
                                className="text-sm text-indigo-600 hover:text-indigo-800 transition duration-300"
                            >
                                Volver a Búsqueda de Cartones
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * Componente principal del administrador (Registro y Lista)
         */
        const AdminApp = ({ setView, showMessage, urlConfig, setUrlConfig }) => {
            const [players, setPlayers] = useState([]);
            const [isLoadingPlayers, setIsLoadingPlayers] = useState(true);
            
            // Estados para el formulario de registro
            const [clientName, setClientName] = useState('');
            const [ticketId, setTicketId] = useState('');
            const [isSavingPlayer, setIsSavingPlayer] = useState(false);

            // Estado local para editar la config antes de guardar
            const [localUrlConfig, setLocalUrlConfig] = useState(urlConfig);
            const [isSavingConfig, setIsSavingConfig] = useState(false);

            // Cargar la lista de jugadores/cartones en tiempo real
            useEffect(() => {
                const q = query(collection(db, PLAYERS_COLLECTION_PATH));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const playersList = [];
                    snapshot.forEach((doc) => {
                        playersList.push({ id: doc.id, ...doc.data() });
                    });
                    // Ordenar localmente por número de ticket
                    playersList.sort((a, b) => parseInt(a.ticketId) - parseInt(b.ticketId));
                    setPlayers(playersList);
                    setIsLoadingPlayers(false);
                }, (error) => {
                    console.error("Error al obtener jugadores:", error);
                    showMessage('Error al cargar datos. Revise la consola.', 'error');
                    setIsLoadingPlayers(false);
                });

                return () => unsubscribe();
            }, []); 
            
            // Sincronizar la configuración global con la local para edición
            useEffect(() => {
                if (urlConfig) {
                    setLocalUrlConfig(urlConfig);
                }
            }, [urlConfig]);

            // Actualiza el estado de la configuración de la URL
            const handleConfigChange = (field, value) => {
                setLocalUrlConfig(prev => ({ ...prev, [field]: value }));
            };

            // Guarda la configuración de URL en Firestore
            const handleSaveConfig = async (e) => {
                e.preventDefault();
                setIsSavingConfig(true);
                await saveUrlConfig(localUrlConfig, showMessage);
                // Actualizar el estado global en el componente padre (App)
                setUrlConfig(localUrlConfig);
                setIsSavingConfig(false);
            };

            // Restablece los campos del formulario de registro
            const resetPlayerForm = () => {
                setClientName('');
                setTicketId('');
                setIsSavingPlayer(false);
            };

            // Maneja el guardado del formulario de registro de jugador
            const handleSavePlayer = async (e) => {
                e.preventDefault();
                const paddedTicket = ticketId.trim().padStart(3, '0');

                if (paddedTicket.length !== 3) {
                    showMessage('El número de ticket debe ser de 3 dígitos.', 'warning');
                    return;
                }
                
                // Validación básica de la configuración antes de guardar el jugador
                if (!localUrlConfig.baseUrl.startsWith('http') || !localUrlConfig.filePrefix || !localUrlConfig.fileExt) {
                    showMessage('La configuración de URL BASE debe ser correcta antes de registrar cartones.', 'error');
                    return;
                }

                setIsSavingPlayer(true);
                // Aquí solo pasamos el nombre y el ticket, la URL se construye dinámicamente.
                await manejarGuardar(clientName, paddedTicket, showMessage, resetPlayerForm);
            };

            const handleLogout = () => manejarCerrarSesion(setView, showMessage);

            if (isLoadingPlayers || !localUrlConfig) {
                return (
                    <div className="h-screen flex items-center justify-center bg-gray-100">
                        <div className="loader"></div>
                        <p className="ml-4 text-lg font-medium text-gray-600">Cargando lista de jugadores...</p>
                    </div>
                );
            }

            // URL de ejemplo para mostrar al administrador
            const exampleTicket = ticketId.trim().padStart(3, '0') || '001';
            const exampleUrl = buildImageUrl(exampleTicket, localUrlConfig);


            return (
                <div className="min-h-screen bg-gray-100 p-4 sm:p-8">
                    <nav className="fixed top-0 left-0 right-0 p-4 bg-white shadow-md z-10 no-print">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <h1 className="text-2xl font-black text-gray-800">
                                BINGO<span className="text-indigo-600">PRO</span>
                            </h1>
                            <div className="flex items-center space-x-4">
                                <button
                                    onClick={() => setView('finder')}
                                    className="px-4 py-2 text-sm text-indigo-600 font-semibold rounded-full border border-indigo-600 hover:bg-indigo-50 transition duration-300"
                                >
                                    Volver a Búsqueda
                                </button>
                                <button
                                    onClick={handleLogout}
                                    className="px-4 py-2 text-sm bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition duration-300"
                                >
                                    Salir
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-4xl mx-auto pt-24 space-y-8">
                        <div className="text-center">
                            <h2 className="text-3xl font-bold text-gray-900">
                                Panel de Administración
                            </h2>
                            <p className="text-gray-500">
                                Mapeo de Jugadores a Cartones Existentes
                            </p>
                        </div>
                        
                        {/* CONFIGURACIÓN DE URL BASE */}
                        <form onSubmit={handleSaveConfig} className="bg-white p-6 rounded-xl shadow-lg w-full border-4 border-yellow-300/50">
                            <h2 className="text-xl font-semibold text-yellow-700 mb-4 flex items-center">
                                <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.228.058 2.573-1.066z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                Configuración de URL Base (Guardada en Firestore)
                            </h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">URL Base PÚBLICA de la Carpeta</label>
                                    <input
                                        type="url"
                                        value={localUrlConfig.baseUrl}
                                        onChange={(e) => handleConfigChange('baseUrl', e.target.value)}
                                        placeholder="Ej: https://raw.githubusercontent.com/user/repo/main/cartones/"
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500"
                                        required
                                    />
                                    <p className="text-xs text-red-500 mt-1">**CRÍTICO:** Debe ser la URL de la carpeta que contiene todas las imágenes.</p>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    {/* Prefijo del Archivo */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Prefijo de Archivo (Ej: carta)</label>
                                        <input
                                            type="text"
                                            value={localUrlConfig.filePrefix}
                                            onChange={(e) => handleConfigChange('filePrefix', e.target.value)}
                                            placeholder="Ej: carta"
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500"
                                            required
                                        />
                                    </div>
                                    {/* Extensión del Archivo */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Extensión de Archivo (Ej: .jpeg)</label>
                                        <select
                                            value={localUrlConfig.fileExt}
                                            onChange={(e) => handleConfigChange('fileExt', e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500"
                                            required
                                        >
                                            <option value=".jpeg">.jpeg</option>
                                            <option value=".png">.png</option>
                                            <option value=".jpg">.jpg</option>
                                        </select>
                                    </div>
                                </div>
                                <p className="text-sm font-bold text-gray-700 pt-2">
                                    URL Completa de Ejemplo Construida:
                                    <br/>
                                    <span className="font-mono text-indigo-600 text-xs break-words">{exampleUrl}</span>
                                </p>
                                <button
                                    type="submit"
                                    disabled={isSavingConfig}
                                    className="w-full py-3 bg-yellow-600 text-white font-semibold rounded-lg shadow-lg hover:bg-yellow-700 transition duration-300 flex items-center justify-center disabled:opacity-50"
                                >
                                    {isSavingConfig ? (
                                        <div className="loader w-5 h-5 border-white border-t-2"></div>
                                    ) : (
                                        'Guardar Configuración de URL en Firestore'
                                    )}
                                </button>
                            </div>
                        </form>


                        {/* Formulario de Nuevo Jugador (Usa la URL Base) */}
                        <form onSubmit={handleSavePlayer} className="bg-white p-6 rounded-xl shadow-lg w-full border-4 border-indigo-300/50">
                            <h2 className="text-xl font-semibold text-indigo-700 mb-4 flex items-center">
                                <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Registrar Nuevo Cartón (Mapear a un Ticket Existente)
                            </h2>
                            <div className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {/* Campo TICKET ID */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">TICKET ID (1-3 dígitos)</label>
                                        <input
                                            type="number"
                                            value={ticketId}
                                            onChange={(e) => setTicketId(e.target.value.slice(0, 3))}
                                            placeholder="Ej: 001"
                                            min="1"
                                            max="999"
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                            required
                                        />
                                        <p className="text-xs text-gray-500 mt-1">Debe coincidir con el número en el archivo (Ej: 001).</p>
                                    </div>
                                    {/* Campo NOMBRE DEL CLIENTE */}
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">NOMBRE DEL CLIENTE</label>
                                        <input
                                            type="text"
                                            value={clientName}
                                            onChange={(e) => setClientName(e.target.value)}
                                            placeholder="Ej: Juan Pérez"
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                            required
                                        />
                                    </div>
                                </div>
                                
                                <button
                                    type="submit"
                                    disabled={isSavingPlayer}
                                    className="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center disabled:opacity-50"
                                >
                                    {isSavingPlayer ? (
                                        <div className="loader w-5 h-5 border-white border-t-2"></div>
                                    ) : (
                                        `Guardar Mapeo (Ticket: ${ticketId.padStart(3, '0') || '001'})`
                                    )}
                                </button>
                            </div>
                        </form>

                        {/* Lista de Cartones (Mantenida para gestión) */}
                        <div className="bg-white p-6 rounded-xl shadow-lg w-full">
                            <h2 className="text-xl font-semibold text-gray-800 mb-4">
                                Lista de Cartones Registrados ({players.length})
                            </h2>
                            <ul className="space-y-3">
                                {players.length > 0 ? (
                                    players.map((player) => (
                                        <li key={player.id} className="flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-md transition duration-200">
                                            <div className="flex items-center space-x-3 mb-2 sm:mb-0">
                                                <span className="font-mono text-sm bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full">
                                                    #{player.ticketId}
                                                </span>
                                                <span className="text-gray-800 font-medium truncate max-w-xs sm:max-w-md">
                                                    {player.clientName}
                                                </span>
                                            </div>
                                            <button
                                                onClick={() => handleDelete(player.id, showMessage)}
                                                className="delete-btn text-xs font-bold"
                                            >
                                                Eliminar
                                            </button>
                                        </li>
                                    ))
                                ) : (
                                    <p className="text-gray-500 text-center py-4">
                                        No hay cartones registrados.
                                    </p>
                                )}
                            </ul>
                        </div>
                    </main>
                </div>
            );
        };

        /**
         * Componente Root de la Aplicación
         */
        const App = () => {
            const [view, setView] = useState('finder'); // 'finder', 'login', 'admin'
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [urlConfig, setUrlConfig] = useState(null);
            const [isLoadingConfig, setIsLoadingConfig] = useState(true);
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('success');
            const [isMessageVisible, setIsMessageVisible] = useState(false);

            // Función para mostrar mensajes modales
            const showMessage = useCallback((msg, type = 'success') => {
                setMessage(msg);
                setMessageType(type);
                setIsMessageVisible(true);
                setTimeout(() => setIsMessageVisible(false), 3000); // Ocultar después de 3s
            }, []);

            // 1. Cargar la configuración de URL Base desde Firestore (necesaria para el buscador público)
            useEffect(() => {
                const unsubscribe = onSnapshot(doc(db, CONFIG_DOC_PATH), (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        setUrlConfig(docSnapshot.data());
                    } else {
                        // Usar valores por defecto si no se ha guardado la configuración
                         setUrlConfig(DEFAULT_URL_CONFIG);
                    }
                    setIsLoadingConfig(false);
                }, (error) => {
                    console.error("Error al cargar la configuración:", error);
                    setIsLoadingConfig(false);
                });

                return () => unsubscribe();
            }, []);

            // 2. Configuración del listener de autenticación
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user && user.uid === FIXED_ADMIN_ID) {
                        setView('admin');
                    } else {
                        setView('finder'); 
                    }
                    setIsAuthReady(true);
                });

                return () => unsubscribe();
            }, []);

            if (!isAuthReady || isLoadingConfig || !urlConfig) {
                return (
                    <div className="h-screen flex items-center justify-center bg-gray-100">
                        <div className="loader"></div>
                        <p className="ml-4 text-lg font-medium text-gray-600">Cargando aplicación y configuración...</p>
                    </div>
                );
            }

            let ComponentToRender;
            
            switch (view) {
                case 'login':
                    ComponentToRender = <AdminLogin setView={setView} showMessage={showMessage} />;
                    break;
                case 'admin':
                    if (auth.currentUser && auth.currentUser.uid === FIXED_ADMIN_ID) {
                         ComponentToRender = <AdminApp 
                                                setView={setView} 
                                                showMessage={showMessage} 
                                                urlConfig={urlConfig}
                                                setUrlConfig={setUrlConfig} 
                                             />;
                    } else {
                         ComponentToRender = <AdminLogin setView={setView} showMessage={showMessage} />;
                    }
                    break;
                case 'finder':
                default:
                    ComponentToRender = <FinderApp setView={setView} showMessage={showMessage} urlConfig={urlConfig} />;
                    break;
            }

            return (
                <>
                    {ComponentToRender}
                    <MessageModal 
                        message={message} 
                        type={messageType} 
                        isVisible={isMessageVisible} 
                        onClose={() => setIsMessageVisible(false)} 
                    />
                </>
            );
        };

        // Renderizar la aplicación
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
